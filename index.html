<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALL KNOWING MEMBERS</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Base Dark Theme Requirement */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Black Background */
            color: #ffffff; /* White Text */
            min-height: 100vh;
        }

        /* Styling for modal overlays */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }
        
        /* Custom modal content background */
        .modal-content {
            background-color: #1a1a1a; /* Very dark grey */
            color: #ffffff;
        }
        
        /* Input styling for dark mode */
        input:not([type="checkbox"]) {
            background-color: #2c2c2c !important; 
            border-color: #4a4a4a !important;
            color: #ffffff !important;
        }

        /* --- Custom Sidebar Roll-Out Styling --- */
        #sidebar {
            transition: transform 0.3s ease; 
            transform: translateX(-100%); 
            z-index: 40; 
        }
        
        .sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (min-width: 768px) {
            #sidebar {
                transform: translateX(0) !important; 
                width: 256px; 
                position: relative; 
            }
        }
        
        #sidebarOverlay {
            transition: opacity 0.3s ease;
        }
        
        /* Custom styles for the grid and button container */
        #categoryContentWrapper {
             display: flex;
             flex-direction: column;
             min-height: 60vh; /* Ensure space for the button to stick to the bottom */
        }
        
        #addWidgetButtonContainer {
            margin-top: 1.5rem; /* Equivalent to mt-6 */
            padding-top: 1.5rem; /* Separate button from the grid */
            border-top: 1px solid #1f2937; /* Gray-800 border */
        }

        /* Party Member Custom Shadow/Ring */
        .shadow-gold {
             box-shadow: 0 0 10px rgba(253, 224, 71, 0.6); /* Soft gold glow */
        }

    </style>
</head>
<body class="bg-black text-white">

    <!-- HEADER: Title and Auth Container -->
    <header class="sticky top-0 z-50 bg-black border-b border-gray-800 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            
            <!-- 1. Hamburger Icon / Left Spacer (Hidden on desktop) -->
            <button id="sidebarToggleBtn" class="text-white p-2 rounded-lg hover:bg-gray-800 transition md:hidden hidden">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <!-- 2. Centered Title Block (Diamond Icon is NOW clickable) -->
            <div class="flex-grow flex items-center justify-center space-x-2 sm:space-x-4">
                <!-- Diamond Icon (Static) -->
                <i data-lucide="diamond" class="w-5 h-5 sm:w-6 sm:h-6 text-red-500 cursor-pointer" onclick="openModal(infoModal); document.getElementById('secretIdInputInModal').focus();"></i>
                
                <h1 class="text-xl sm:text-3xl font-extrabold tracking-wider text-red-500 cursor-pointer hover:opacity-80 transition"
                    onclick="location.reload()">
                    ALL KNOWING MEMBERS
                </h1>
                
                <!-- Info Button -->
                <button id="infoBtn" class="p-1 rounded-full text-red-500 hover:bg-gray-800 transition">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- 3. Auth Button / Profile Icon -->
            <div id="authContainer" class="flex-shrink-0">
                <!-- Content injected by JavaScript (Sign In Button or Profile Icon) -->
            </div>
            
        </div>
    </header>

    <!-- MAIN CONTENT AREA / DASHBOARD CONTAINER -->
    <main class="relative">
        
        <!-- Welcome Screen (Initial logged-in view) -->
        <div id="welcomeScreen" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
             <h2 class="text-3xl font-light text-gray-400">Loading...</h2>
             <p class="mt-4 text-gray-500">Attempting to restore session.</p>
        </div>

        <!-- Dashboard View (Files, Categories, Content) -->
        <div id="dashboardView" class="hidden min-h-[80vh] md:flex">
            
            <!-- Responsive Sidebar (The vertical side menu) -->
            <div id="sidebar" class="fixed inset-y-0 w-64 bg-gray-900 border-r border-gray-800 p-4 pt-12 md:relative md:pt-4">
                <h3 class="text-xl font-bold mb-6 text-red-500 border-b border-gray-700 pb-2">CATEGORIES</h3>
                <nav class="space-y-2">
                    <!-- Categories listed vertically on the side -->
                    <button class="category-link w-full text-left flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition" data-category="Crime">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-3"></i>
                        Crime
                    </button>
                    <button class="category-link w-full text-left flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition" data-category="Politics">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                        Politics
                    </button>
                    <button class="category-link w-full text-left flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition" data-category="Government">
                        <i data-lucide="landmark" class="w-5 h-5 mr-3"></i>
                        Government
                    </button>
                    <button class="category-link w-full text-left flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition" data-category="Worldwide">
                        <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                        Worldwide
                    </button>
                    <button class="category-link w-full text-left flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition" data-category="Educational">
                        <i data-lucide="graduation-cap" class="w-5 h-5 mr-3"></i>
                        Educational
                    </button>
                </nav>
            </div>

            <!-- Main Content Panel -->
            <div id="dashboardContent" class="flex-1 p-8 pt-4 transition-all duration-300 w-full md:w-auto">
                <h2 class="text-3xl font-bold text-white mb-6">File System Access</h2>
                <div class="bg-gray-900 p-6 rounded-xl min-h-[60vh] border border-gray-800">
                    <h3 id="currentCategoryTitle" class="text-2xl text-red-500 font-semibold mb-6">Select a Category</h3>
                    
                    <!-- Content Wrapper for the grid and the button -->
                    <div id="categoryContentWrapper" class="flex-grow">
                        <div id="currentCategoryContent" class="text-gray-400 flex-grow">
                            Welcome to the classified file directory. Click on a category in the sidebar to load the relevant data.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Overlay (for mobile: hides content when sidebar is open) -->
            <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

        </div>
        
        <!-- ADMINISTRATOR SETTING VIEW (NEW CONTENT) -->
        <div id="adminSettingsView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="bg-gray-900 p-8 rounded-xl border-4 border-yellow-500 shadow-2xl shadow-yellow-900/50">
                <div class="flex items-center justify-between border-b border-gray-700 pb-4 mb-6">
                    <h2 class="text-4xl font-extrabold tracking-wider text-yellow-400 flex items-center">
                        <i data-lucide="lock-keyhole" class="w-8 h-8 mr-4"></i>
                        ADMINISTRATOR SETTING
                    </h2>
                    <button id="backToDashboardBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition flex items-center">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                        Back to Dashboard
                    </button>
                </div>

                <div class="space-y-6">
                    <p class="text-lg text-gray-300">
                        Access level **ECHO-ALPHA** confirmed. This area contains sensitive control settings for the member portal configuration and data logs.
                    </p>
                    
                    <!-- Placeholder Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg border-l-4 border-yellow-600">
                            <h3 class="text-xl font-semibold text-yellow-500 mb-2">Member Log Management</h3>
                            <p class="text-sm text-gray-400 mb-3">View and edit access logs and user registration records.</p>
                            <button class="w-full py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-bold">
                                View Logs (Simulated)
                            </button>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg border-l-4 border-yellow-600">
                            <h3 class="text-xl font-semibold text-yellow-500 mb-2">System Status Monitor</h3>
                            <p class="text-sm text-gray-400 mb-3">Check the real-time health and performance of the Firebase backend.</p>
                            <button class="w-full py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-bold">
                                System Check (Simulated)
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-700">
                        <p class="text-sm text-red-500 italic">
                            Warning: Actions in this section cannot be undone. Proceed with caution.
                        </p>
                    </div>
                </div>

            </div>
        </div>


    </main>

    <!-- MODALS (Unchanged) -->
    
    <!-- 1. AUTHENTICATION MODAL (Sign In / Log In) -->
    <div id="authModal" 
         class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center opacity-0"
         aria-modal="true" 
         role="dialog">
        
        <div class="modal-content p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 relative">
            
            <button id="closeAuthModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h3 class="text-3xl font-bold mb-6 text-center text-red-500">Member Access</h3>
            
            <!-- Manual Sign Up / Log In Form -->
            <form id="loginForm" class="space-y-4">
                <input type="text" id="name" placeholder="Full Name" required class="w-full p-3 rounded-lg border border-gray-700">
                <input type="email" id="email" placeholder="Gmail Address" required class="w-full p-3 rounded-lg border border-gray-700">
                <input type="text" id="username" placeholder="Username" required class="w-full p-3 rounded-lg border border-gray-700">
                <button type="submit" class="w-full py-3 bg-red-600 rounded-lg font-bold hover:bg-red-700 transition duration-150 shadow-lg shadow-red-900/50">
                    Sign Up / Log In
                </button>
            </form>

        </div>
    </div>

    <!-- 2. PROFILE MODAL (About Account, IDs, Log Out) -->
    <div id="profileModal" 
         class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center opacity-0"
         aria-modal="true" 
         role="dialog">
        
        <div class="modal-content p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 relative">
            
            <button id="closeProfileModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="flex flex-col items-center border-b border-gray-700 pb-6 mb-6">
                <div class="w-20 h-20 rounded-full bg-red-600 flex items-center justify-center text-4xl font-bold">
                    <span id="profileInitial">U</span>
                </div>
                <h3 id="profileUsernameDisplay" class="text-3xl font-bold mt-4 text-white">User Name</h3>
                <p class="text-sm text-gray-400" id="profileEmailDisplay"></p>
                <div id="partyBadge" class="mt-2 text-sm font-semibold px-3 py-1 rounded-full bg-yellow-900/50 text-yellow-400 hidden">
                    <i data-lucide="diamond" class="w-4 h-4 mr-1 inline-block"></i>
                    Party Member
                </div>
            </div>

            <div class="space-y-6">
                
                <!-- Persistent Member ID -->
                <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="text-lg font-semibold text-red-500">MEMBER ID (Persistent)</p>
                        <p class="text-2xl font-mono tracking-widest mt-1" id="memberIdDisplay">XXXXXX</p>
                    </div>
                    <button data-id-type="memberIdDisplay" class="copy-btn p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                        <i data-lucide="copy" class="w-5 h-5 text-gray-300"></i>
                    </button>
                </div>
                
                <!-- Admin Record ID (Firestore Doc ID) -->
                <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="text-lg font-semibold text-red-500">ADMIN RECORD ID (Firestore)</p>
                        <p class="text-sm font-mono tracking-wider mt-1 break-all" id="adminRecordIdDisplay">
                            FETCHING...
                        </p>
                    </div>
                     <button data-id-type="adminRecordIdDisplay" class="copy-btn p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                        <i data-lucide="copy" class="w-5 h-5 text-gray-300"></i>
                    </button>
                </div>
                
                <!-- About Account Details -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-lg font-semibold text-red-500 mb-3 border-b border-gray-700 pb-2">ABOUT ACCOUNT</p>
                    <dl class="space-y-2 text-sm text-left">
                        <div class="flex justify-between">
                            <dt class="text-gray-400">Username:</dt>
                            <dd id="aboutUsername" class="font-medium"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-400">Gmail Used:</dt>
                            <dd id="aboutEmail" class="font-medium"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-400">Account Type:</dt>
                            <dd id="aboutMethod" class="font-medium text-green-400"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-400">Party Member Status:</dt>
                            <dd id="aboutPartyStatus" class="font-medium"></dd>
                        </div>
                    </dl>
                </div>

                <!-- Log Out Button -->
                <button id="changeUserBtn" class="w-full py-3 bg-red-600 rounded-lg font-bold hover:bg-red-700 transition duration-150">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2 inline-block"></i> Change User (Log Out)
                </button>
                
            </div>
            
            <!-- Copy Notification -->
            <div id="copyMessage" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 p-3 bg-green-600 text-white rounded-lg shadow-xl text-sm hidden transition duration-300 opacity-0">
                ID copied to clipboard!
            </div>
        </div>
    </div>
    
    <!-- 3. INFO MODAL (For Secret ID Input/Processing) -->
    <div id="infoModal" 
         class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center opacity-0"
         aria-modal="true" 
         role="dialog">
        
        <div class="modal-content p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 relative">
            
            <button id="closeInfoModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h3 class="text-3xl font-bold mb-4 text-center text-red-500 flex items-center justify-center">
                <i data-lucide="key" class="w-6 h-6 mr-3"></i>
                SECRET CODE ENTRY
            </h3>
            
            <p class="text-gray-400 text-sm text-center mb-6">
                Enter the secret numerical code below and press <span class="font-mono text-xs bg-gray-700 text-yellow-300 px-1 py-0.5 rounded-md">Enter</span>.
            </p>

            <!-- Input Field for Secret Code -->
            <div class="mb-6">
                <input 
                    type="text" 
                    id="secretIdInputInModal" 
                    placeholder="Enter numerical code..."
                    maxlength="12"
                    class="w-full px-4 py-3 bg-gray-700 text-white border-2 border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 shadow-inner text-xl tracking-wider text-center"
                    autofocus
                >
            </div>
            
            <!-- Feedback/Output Area -->
            <div id="secretCodeFeedback" class="min-h-12 p-3 bg-gray-900 rounded-lg text-center border-t-4 border-indigo-600">
                <p id="feedbackText" class="text-gray-400 text-base italic">Awaiting code...</p>
            </div>

        </div>
    </div>


    <!-- FIREBASE AND JAVASCRIPT LOGIC -->
    <script type="module">
        // Import Firebase modules (v11.11.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.11.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.11.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.11.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.11.1/firebase-firestore.js";
        // --- NEW: Import Firebase Storage ---
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.11.1/firebase-storage.js";
        
        // --- GLOBAL VARIABLES (Provided by Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE SETUP ---
        let app, db, auth, storage, userId; // <-- Added 'storage'
        let currentUser = null; 
        setLogLevel('Debug'); 

        // --- STATE MANAGEMENT ---
        let widgetStates = {}; // Will hold widget data *per category* as it's loaded
        const MAX_FILE_SIZE_BYTES = 2 * 1024 * 1024 * 1024; // 2 GB

        // --- DOM REFERENCES ---
        const body = document.body;
        const authContainer = document.getElementById('authContainer');
        const authModal = document.getElementById('authModal');
        const loginForm = document.getElementById('loginForm');
        
        const welcomeScreen = document.getElementById('welcomeScreen');
        const dashboardView = document.getElementById('dashboardView');
        const adminSettingsView = document.getElementById('adminSettingsView'); 
        const backToDashboardBtn = document.getElementById('backToDashboardBtn'); 

        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const currentCategoryTitle = document.getElementById('currentCategoryTitle');
        const categoryContentWrapper = document.getElementById('categoryContentWrapper');
        
        const profileModal = document.getElementById('profileModal');
        const infoModal = document.getElementById('infoModal'); 
        const infoBtn = document.getElementById('infoBtn');     
        const changeUserBtn = document.getElementById('changeUserBtn');
        
        const copyButtons = document.querySelectorAll('.copy-btn');
        const categoryLinks = document.querySelectorAll('.category-link');
        
        // Secret ID Input Elements
        const secretIdInput = document.getElementById('secretIdInputInModal');
        const feedbackText = document.getElementById('feedbackText');

        let isDashboardActive = false;
        let isSidebarOpen = false;


        // --- UTILITY FUNCTIONS ---
        
        /**
         * Generates a random 6-character alphanumeric Member ID.
         */
        function generateMemberId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        /**
         * Formats bytes into a human-readable string (KB, MB, GB).
         */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /**
         * Finds the next sequential index for a widget in a given category.
         * @param {string} category The category name (e.g., 'Crime').
         * @returns {number} The next available index.
         */
        function getNextWidgetIndex(category) {
            let maxIndex = 0;
            // Iterate over all widget IDs in the state
            for (const key in widgetStates) {
                if (key.startsWith(category + '-')) {
                    // Extract the index part of the ID (e.g., 'Crime-3' -> 3)
                    const index = parseInt(key.split('-')[1]);
                    if (!isNaN(index) && index > maxIndex) {
                        maxIndex = index;
                    }
                }
            }
            // Start dynamic indices from 5 (since 1-4 are pre-initialized)
            return Math.max(5, maxIndex + 1); 
        }

        // --- DATA PERSISTENCE FUNCTIONS ---

        /**
         * Saves the current state of all widgets for a specific category to Firestore.
         * @param {string} category The category name (e.g., "Crime").
         */
        async function saveCategoryWidgets(category) {
            if (!currentUser || !currentUser.adminRecordId || !db) {
                console.warn("Cannot save widgets: No user or database connection.");
                return;
            }

            // 1. Build the object to save
            const widgetsToSave = {};
            for (const key in widgetStates) {
                if (key.startsWith(category + '-')) {
                    // Create a clean copy, now including storage paths and URLs
                    const { name, fileName, fileSize, fileType, downloadURL, storagePath } = widgetStates[key];
                    widgetsToSave[key] = { name, fileName, fileSize, fileType, downloadURL, storagePath }; 
                }
            }

            // 2. Get the document path
            const docPath = `artifacts/${appId}/public/data/members/${currentUser.adminRecordId}/widgets/${category}`;
            const docRef = doc(db, docPath);

            try {
                // 3. Save to Firestore (overwrites the entire 'widgets' map)
                await setDoc(docRef, { widgets: widgetsToSave });
                console.log(`Successfully saved widgets for category: ${category}`);
            } catch (error) {
                console.error("Error saving widgets to Firestore:", error);
            }
        }

        // --- FILE HANDLING FUNCTIONS ---
        
        /**
         * Opens the file in a new browser tab. 
         * It prioritizes the persistent downloadURL, but falls back to the temporary
         * fileURL (from createObjectURL) for immediate previews.
         * @param {string} widgetId Unique ID of the widget (e.g., 'Crime-1').
         */
        function openFileInNewTab(widgetId) {
            const state = widgetStates[widgetId];
            
            // Prioritize persistent URL, fallback to temporary session URL
            const urlToOpen = state.downloadURL || state.fileURL;
            
            if (urlToOpen) {
                // Open the URL in a new tab
                window.open(urlToOpen, '_blank');
                console.log(`Opening file: ${state.fileName}`);
            } else {
                // This happens if there's no file attached at all.
                console.warn(`No file URL (persistent or temporary) available for ${widgetId}.`);
                
                // Optional: Provide UI feedback
                const message = document.createElement('div');
                message.className = 'fixed top-20 right-4 p-4 bg-yellow-600 text-white rounded-lg shadow-xl z-50 transition-opacity duration-500';
                message.textContent = 'Error: No file is attached to this widget.';
                document.body.appendChild(message);
                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => message.remove(), 500);
                }, 3000);
            }
        }
        window.openFileInNewTab = openFileInNewTab; // Expose globally 
        
        /**
         * Renders the widget content based on the current state data.
         * @param {string} widgetId Unique ID of the widget (e.g., 'Crime-1').
         * @returns {string} HTML string for the widget card.
         */
        function renderWidget(widgetId) {
            const state = widgetStates[widgetId];
            
            // Ensure state exists (fallback)
            if (!state) {
                console.error(`No state found for widgetId: ${widgetId}`);
                return ''; // Don't render if state is missing
            }
            
            const icon = state.isEditing ? 'save' : 'pencil';
            const buttonColor = state.isEditing ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-700 hover:bg-gray-600';
            const categoryBase = widgetId.split('-')[0];

            // Define a color for the card border based on category for visual distinction
            let borderColor = 'border-red-600';
            if (categoryBase === 'Politics') borderColor = 'border-blue-600';
            else if (categoryBase === 'Government') borderColor = 'border-yellow-600';
            else if (categoryBase === 'Worldwide') borderColor = 'border-purple-600';
            else if (categoryBase === 'Educational') borderColor = 'border-green-600';


            // --- FILE PREVIEW LOGIC ---
            let filePreview = '';
            const hasFile = state.fileName;
            const fileType = state.fileType || '';
            
            // Use the temporary session URL (fileURL) if it exists, otherwise use the persistent one (downloadURL)
            const previewMediaURL = state.fileURL || state.downloadURL;
            
            // Determine icon and color for the file details block
            let fileIcon = 'file-text';
            let iconColor = 'text-green-400';
            
            if (fileType.includes('pdf')) {
                fileIcon = 'file-type-2'; iconColor = 'text-red-400';
            } else if (fileType.startsWith('image/')) {
                fileIcon = 'image'; iconColor = 'text-blue-400';
            } else if (fileType.startsWith('video/')) {
                fileIcon = 'video'; iconColor = 'text-purple-400';
            } else if (hasFile) {
                 fileIcon = 'file-question'; iconColor = 'text-yellow-400';
            }

            if (hasFile) {
                // File is clickable if a persistent or temporary URL exists
                const clickableClass = (previewMediaURL) ? 'cursor-pointer hover:bg-gray-700/70 transition' : 'cursor-default';
                const actionAttr = (previewMediaURL) ? `data-action="open-file" data-id="${widgetId}"` : '';

                let innerContent = '';
                
                // 1. Create the main preview block content (80px height block)
                if (previewMediaURL && (fileType.startsWith('image/') || fileType.startsWith('video/'))) {
                    // LIVE PREVIEW (Image or Video) - Sourced from temp OR persistent URL
                    const mediaTag = fileType.startsWith('image/') 
                        ? `<img src="${previewMediaURL}" alt="File preview" class="w-full h-32 object-contain p-2">`
                        : `<video src="${previewMediaURL}" preload="metadata" class="w-full h-32 object-contain p-2"></video>`;
                    
                    innerContent = `
                        <div class="relative w-full h-32 bg-black flex items-center justify-center">
                            ${mediaTag}
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center">
                                <i data-lucide="external-link" class="w-8 h-8 text-white"></i>
                                <span class="text-sm text-white mt-1 font-semibold">Click to View File</span>
                            </div>
                        </div>`;
                } else {
                    // PERSISTENT THUMBNAIL (Generic file type)
                    innerContent = `
                        <div class="flex flex-col items-center justify-center h-20 text-center p-3">
                            <i data-lucide="${fileIcon}" class="w-8 h-8 ${iconColor} mb-1"></i>
                            <span class="text-xs text-gray-300 font-semibold mt-1">File Attached</span>
                            <span class="text-xs text-gray-500">${state.downloadURL ? 'File is persistent' : 'Session-only preview'}</span>
                        </div>
                    `;
                }
                
                // 2. The main file preview block container
                filePreview = `
                    <div ${actionAttr} class="file-preview-block mt-4 rounded-lg overflow-hidden border-2 border-gray-700 ${clickableClass} group">
                        ${innerContent}
                    </div>
                    <div class="mt-2 p-2 bg-gray-700/50 rounded-lg flex items-center justify-between text-sm">
                        <div class="flex items-center truncate">
                            <i data-lucide="${fileIcon}" class="w-4 h-4 mr-2 ${iconColor} flex-shrink-0"></i>
                            <span class="text-white truncate" title="${state.fileName}">${state.fileName}</span>
                        </div>
                        <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${formatBytes(state.fileSize || 0)}</span>
                    </div>`;

            } else {
                // Case: No file attached
                filePreview = `
                    <div class="mt-4 p-2 bg-gray-700/50 rounded-lg flex items-center justify-center text-gray-500 text-xs font-mono border border-dashed border-gray-600 h-20">
                        No file attached. Max size: 2 GB
                    </div>`;
            }
            // --- END FILE PREVIEW LOGIC ---

            // --- UPLOADING OVERLAY ---
            const uploadingOverlay = state.isUploading ? `
                <div class="absolute inset-0 bg-gray-900/80 flex flex-col items-center justify-center z-10 rounded-xl">
                    <i data-lucide="upload-cloud" class="w-12 h-12 text-red-500 animate-pulse"></i>
                    <p class="text-white font-semibold mt-2">Uploading file...</p>
                </div>
            ` : '';

            return `
                <div id="widget-${widgetId}" class="relative bg-gray-800 p-6 rounded-xl border-t-4 ${borderColor} shadow-xl transition hover:shadow-red-900/50">
                    ${uploadingOverlay}
                    
                    <div class="flex justify-between items-start mb-3">
                        ${state.isEditing ? 
                            `<input type="text" id="input-${widgetId}" value="${state.name}" class="text-xl font-bold p-1 w-2/3 rounded-lg text-white bg-gray-700 border-red-500" required>` : 
                            `<h4 class="text-xl font-bold text-red-400" id="name-${widgetId}">${state.name}</h4>`
                        }
                        <button data-id="${widgetId}" data-action="toggle-edit" class="widget-action p-2 rounded-full text-white ${buttonColor} transition duration-150">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                        </button>
                    </div>

                    ${filePreview}

                    <!-- File Upload Section -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <!-- Hidden File Input -->
                        <input type="file" id="file-${widgetId}" data-id="${widgetId}" class="hidden widget-action" data-action="file-change">
                        
                        <!-- Visible Browse Button -->
                        <button onclick="document.getElementById('file-${widgetId}').click()" class="px-3 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition flex items-center">
                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Upload File
                        </button>
                        
                        <!-- DOWNLOAD THIS FILE BUTTON -->
                        ${state.fileName ? `<button data-id="${widgetId}" data-action="open-file" class="widget-action px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition flex items-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> DOWNLOAD THIS FILE
                        </button>` : ''}
                        
                        <!-- Remove File Button -->
                        ${state.fileName ? `<button data-id="${widgetId}" data-action="remove-file" class="widget-action px-3 py-2 bg-red-900/50 text-red-300 rounded-lg text-sm font-semibold hover:bg-red-900 transition flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Remove
                        </button>` : ''}
                    </div>
                    <p id="error-${widgetId}" class="text-sm text-red-400 mt-2 hidden">File too large (Max 2 GB).</p>
                </div>
            `;
        }
        
        /**
         * Re-renders a single widget in place.
         * @param {string} widgetId The ID of the widget to re-render.
         */
        function reRenderWidget(widgetId) {
            const widgetElement = document.getElementById(`widget-${widgetId}`);
            if(widgetElement) {
                const newHTML = renderWidget(widgetId);
                // Use DOM manipulation to replace the old element with the new one
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newHTML;
                const newElement = tempDiv.firstChild;
                widgetElement.parentNode.replaceChild(newElement, widgetElement);
                lucide.createIcons();
                
                // If now editing, focus the input
                const state = widgetStates[widgetId];
                if (state && state.isEditing) {
                    const input = document.getElementById(`input-${widgetId}`);
                    if (input) input.focus();
                }
            }
        }

        /**
         * Generates the HTML for a single placeholder widget card and ensures its state is initialized.
         * @param {string} category The category name.
         * @param {number} index The widget index within the category.
         * @returns {string} HTML string for the widget card.
         */
        function generateWidgetHTML(category, index) {
            const widgetId = `${category}-${index}`;
            // State should have been initialized by handleCategorySelect, but we double-check.
            if (!widgetStates[widgetId]) {
                console.warn(`State for ${widgetId} was not pre-loaded. Creating default.`);
                widgetStates[widgetId] = { 
                    name: `${category} Metrics ${index}`, 
                    fileName: null, 
                    fileSize: null, 
                    fileType: null,
                    fileURL: null, // Temporary session URL
                    downloadURL: null, // Persistent storage URL
                    storagePath: null, // Path in Firebase Storage
                    isEditing: false,
                    isUploading: false
                };
            }
            return renderWidget(widgetId);
        }

        /**
         * Toggles the editing state and saves the name if applicable.
         */
        async function toggleWidgetEdit(widgetId) {
            const state = widgetStates[widgetId];
            const category = widgetId.split('-')[0];
            
            if (state.isEditing) {
                // Save action
                const inputElement = document.getElementById(`input-${widgetId}`);
                if (inputElement) {
                    const newName = inputElement.value.trim();
                    state.name = newName || state.name; // Keep old name if input is empty
                }
                state.isEditing = false;
                
                // --- SAVE TO FIRESTORE ---
                await saveCategoryWidgets(category);
                // -------------------------

            } else {
                // Edit action
                state.isEditing = true;
            }
            
            // Re-render
            reRenderWidget(widgetId);
        }

        /**
         * Handles the file change event, checking size, updating state, and uploading to Storage.
         */
        async function handleFileUpload(widgetId, file) {
            const errorElement = document.getElementById(`error-${widgetId}`);
            if (errorElement) errorElement.classList.add('hidden');

            const state = widgetStates[widgetId];
            const category = widgetId.split('-')[0];

            // --- Clean up old ObjectURL if one exists ---
            if (state.fileURL) {
                URL.revokeObjectURL(state.fileURL);
                state.fileURL = null;
            }
            
            // --- If a file was already associated, delete it from Storage first ---
            if (state.storagePath) {
                console.log(`Removing old file: ${state.storagePath}`);
                const oldStorageRef = ref(storage, state.storagePath);
                try {
                    await deleteObject(oldStorageRef);
                } catch (error) {
                    console.warn("Error deleting old file from storage (might not exist):", error);
                }
                state.storagePath = null;
                state.downloadURL = null;
            }
            // --- END ---

            if (file) {
                if (file.size > MAX_FILE_SIZE_BYTES) {
                    // File too large
                    if (errorElement) errorElement.classList.remove('hidden');
                    state.fileName = null;
                    state.fileSize = null;
                    state.fileType = null;
                    console.error("File exceeds 2GB limit. Upload failed.");
                    reRenderWidget(widgetId); // Re-render to clear any old file info
                    return;
                } 
                
                // --- File OK, update state for immediate preview ---
                state.fileName = file.name;
                state.fileSize = file.size;
                state.fileType = file.type; // Store MIME type
                state.fileURL = URL.createObjectURL(file); // Create temporary session URL
                state.isUploading = true;
                
                // Re-render to show session preview and loading indicator
                reRenderWidget(widgetId);
                
                try {
                    // --- UPLOAD TO FIREBASE STORAGE ---
                    const storagePath = `artifacts/${appId}/user_files/${currentUser.adminRecordId}/${category}/${Date.now()}-${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    
                    console.log(`Uploading to: ${storagePath}`);
                    await uploadBytes(storageRef, file);
                    
                    // Get persistent URL
                    const downloadURL = await getDownloadURL(storageRef);
                    console.log(`Upload complete. URL: ${downloadURL}`);
                    
                    // Update state with persistent data
                    state.downloadURL = downloadURL;
                    state.storagePath = storagePath;
                    
                } catch (error) {
                    console.error("Error uploading file to Firebase Storage:", error);
                    // Clear file info on error
                    state.fileName = null;
                    state.fileSize = null;
                    state.fileType = null;
                    if (state.fileURL) {
                         URL.revokeObjectURL(state.fileURL);
                         state.fileURL = null;
                    }
                } finally {
                    // --- Final state update ---
                    state.isUploading = false;
                    
                    // --- SAVE METADATA TO FIRESTORE ---
                    await saveCategoryWidgets(category);
                    
                    // Re-render to remove loading indicator and show final state
                    reRenderWidget(widgetId);
                }
                
            } else {
                // No file selected (e.g., user cancelled)
                return;
            }
        }

        /**
         * Removes the attached file from the widget state and deletes it from Firebase Storage.
         */
        async function removeFile(widgetId) {
            const state = widgetStates[widgetId];
            const category = widgetId.split('-')[0];
            
            // --- 1. Delete from Firebase Storage ---
            if (state.storagePath) {
                console.log(`Deleting from Storage: ${state.storagePath}`);
                const storageRef = ref(storage, state.storagePath);
                try {
                    await deleteObject(storageRef);
                } catch (error) {
                    console.warn("Error deleting file from storage (might not exist):", error);
                }
            }
            
            // --- 2. Clean up local ObjectURL ---
            if (state.fileURL) {
                URL.revokeObjectURL(state.fileURL);
            }
            
            // --- 3. Clear state ---
            state.fileName = null;
            state.fileSize = null;
            state.fileType = null;
            state.fileURL = null;
            state.downloadURL = null;
            state.storagePath = null;
            state.isUploading = false;
            
            // --- 4. SAVE TO FIRESTORE ---
            await saveCategoryWidgets(category);
            
            // --- 5. Re-render ---
            reRenderWidget(widgetId);
        }
        
        /**
         * Adds a new widget to the current category and updates the DOM.
         * @param {string} category The current active category.
         */
        async function addNewWidget(category) {
            const newIndex = getNextWidgetIndex(category);
            const widgetId = `${category}-${newIndex}`;
            
            // 1. Initialize state for the new widget
            widgetStates[widgetId] = {
                name: `New ${category} Report ${newIndex}`, 
                fileName: null, 
                fileSize: null, 
                fileType: null,
                fileURL: null,
                downloadURL: null,
                storagePath: null,
                isEditing: true, // Start in edit mode for immediate naming
                isUploading: false
            };
            
            // 2. Get the HTML and create the element
            const newHTML = renderWidget(widgetId);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newHTML;
            const newElement = tempDiv.firstChild;

            // 3. Append the new widget to the grid
            const widgetGrid = document.getElementById('widgetGrid');
            if (widgetGrid) {
                widgetGrid.appendChild(newElement);
                lucide.createIcons(); // Re-render lucide icons
                
                // Optional: Scroll to the new widget
                newElement.scrollIntoView({ behavior: 'smooth' });
                
                // Optional: Focus the input for renaming
                setTimeout(() => {
                    const input = document.getElementById(`input-${widgetId}`);
                    if (input) input.focus();
                }, 100);

            } else {
                console.error("Widget grid not found.");
            }
            
            // --- SAVE TO FIRESTORE ---
            await saveCategoryWidgets(category);
            // -------------------------
            
            console.log(`New widget ${widgetId} added to category ${category}`);
        }


        /**
         * Opens a modal with a smooth transition.
         */
        function openModal(modal) {
            const content = modal.querySelector('.modal-content') || modal.querySelector('div.bg-gray-900');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.classList.add('opacity-100');
                if (content) {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }
            }, 10);
        }

        /**
         * Closes a modal with a smooth transition.
         */
        function closeModal(modal) {
            const content = modal.querySelector('.modal-content') || modal.querySelector('div.bg-gray-900');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }
        
        /**
         * Shows the main application dashboard and hides other specialized views.
         */
        function showDashboard() {
            dashboardView.classList.remove('hidden');
            dashboardView.classList.add('flex');
            welcomeScreen.classList.add('hidden');
            adminSettingsView.classList.add('hidden');
            isDashboardActive = true;
            sidebarToggleBtn.classList.remove('hidden');
            lucide.createIcons();
        }

        /**
         * Shows the Administrator Settings view and hides all others.
         */
        function showAdminSettings() {
            adminSettingsView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            isDashboardActive = false;
            sidebarToggleBtn.classList.add('hidden');
            lucide.createIcons();
        }
        
        /**
         * Processes the code entered in the Secret ID modal.
         */
        function processSecretId() {
            const secretId = secretIdInput.value.trim();
            const correctCode = '1511'; // The required secret code
            
            // Reset feedback style
            feedbackText.className = 'text-gray-400 text-base italic';
            secretIdInput.value = ''; // Clear the input regardless of success/fail

            if (secretId === '') {
                feedbackText.textContent = "Input is empty. Please enter a numerical code.";
                feedbackText.classList.add('text-red-400', 'font-semibold');
                secretIdInput.focus();
                return;
            }

            // Simple validation to ensure it's purely numerical
            if (!/^\d+$/.test(secretId)) {
                feedbackText.textContent = "Error: Code must be strictly numerical.";
                feedbackText.classList.add('text-red-400', 'font-semibold');
                return;
            }

            // --- FIXED LOGIC IMPLEMENTATION: SWITCH TO ADMIN VIEW ---
            if (secretId === correctCode) {
                feedbackText.innerHTML = `
                    <span class="text-green-400 font-bold text-xl">SECRET ID RIGHT!</span><br>
                    <span class="text-gray-300 text-sm">Initiating Admin Protocol...</span>
                `;
                feedbackText.classList.remove('text-gray-400', 'italic');
                
                // Delay the transition slightly for the user to read the success message
                setTimeout(() => {
                    closeModal(infoModal);
                    showAdminSettings();
                }, 800);

            } else {
                // Incorrect Code
                feedbackText.textContent = "Code Incorrect. Access Denied.";
                feedbackText.classList.add('text-red-400', 'font-semibold');
            }
            // --- END FIXED LOGIC ---
        }


        // --- EXPOSE GLOBAL FUNCTIONS FOR INLINE HTML LISTENERS ---
        // These functions need to be exposed to the global window object 
        // to be callable from the inline 'onclick' attribute in the HTML.
        window.openModal = openModal;
        window.closeModal = closeModal;


        /**
         * Clears all session data (logout logic).
         */
        async function clearUser() {
            currentUser = null;
            sessionStorage.removeItem('allKnowingUser');
            isDashboardActive = false;
            widgetStates = {}; // Clear widget state on logout
            
            if (auth) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
            initializeAppAndAuth(); 
        }
        
        /**
         * Toggles the dashboard view visibility.
         */
        function toggleDashboardView(show) {
            isDashboardActive = show;
            
            if (show) {
                showDashboard();
            } else {
                welcomeScreen.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                dashboardView.classList.remove('flex');
                adminSettingsView.classList.add('hidden'); // Ensure admin view is hidden on logout
                sidebarToggleBtn.classList.add('hidden');
            }
        }
        
        /**
         * Handles the access files action, enabling the dashboard view.
         */
        function handleAccessFiles() {
            toggleDashboardView(true);
        }
        
        /**
         * Toggles the sidebar visibility (mobile roll-out mechanism).
         */
        function handleSidebarToggle(force) {
            if (window.innerWidth >= 768) {
                return;
            }

            if (typeof force === 'boolean') {
                isSidebarOpen = force;
            } else {
                isSidebarOpen = !isSidebarOpen;
            }

            if (isSidebarOpen) {
                body.classList.add('sidebar-open', 'overflow-hidden');
                sidebar.style.transform = 'translateX(0)'; // Roll-out
                sidebarOverlay.classList.remove('hidden');
            } else {
                body.classList.remove('sidebar-open', 'overflow-hidden');
                sidebar.style.transform = 'translateX(-100%)'; // Roll-in/Hide
                sidebarOverlay.classList.add('hidden');
            }
        }
        
        /**
         * Updates the UI (Header and Main Content) based on the currentUser state.
         */
        function updateAppUI() {
            authContainer.innerHTML = ''; 
            
            // Only show the hamburger menu if the user is logged in AND on the dashboard
            if (currentUser && isDashboardActive && dashboardView.classList.contains('flex')) {
                sidebarToggleBtn.classList.remove('hidden');
            } else {
                sidebarToggleBtn.classList.add('hidden');
            }


            if (currentUser) {
                // 1. Logged In: Show Profile Icon with Party Badge if applicable
                const initial = currentUser.name ? currentUser.name[0].toUpperCase() : 'U';
                
                // Create a wrapper for the icon and the badge
                const profileWrapper = document.createElement('div');
                profileWrapper.className = 'relative flex-shrink-0';
                
                const profileBtn = document.createElement('button');
                profileBtn.id = 'profileBtn';
                
                // Base classes for the profile circle
                let buttonClasses = 'w-10 h-10 rounded-full bg-red-600 text-white font-bold flex items-center justify-center text-lg hover:ring-2 ring-red-400 transition shadow-lg';
                
                if (currentUser.isPartyMember) {
                    // Add gold border, offset ring, and custom shadow for "Party" distinction
                    buttonClasses += ' ring-4 ring-offset-2 ring-offset-black ring-yellow-500 shadow-gold';
                    
                    // Add Diamond Badge SVG container
                    const diamondBadge = document.createElement('div');
                    // Positioned at bottom-[-2px] right-[-2px]
                    diamondBadge.className = 'absolute bottom-[-2px] right-[-2px] w-5 h-5 flex items-center justify-center bg-black rounded-full border border-yellow-500 shadow-lg';
                    
                    // Inline SVG for the diamond shape
                    diamondBadge.innerHTML = `
                        <svg class="w-3 h-3 text-yellow-400 transform -rotate-45" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0l-8 12 8 12 8-12z"/>
                        </svg>
                    `;
                    profileWrapper.appendChild(diamondBadge);
                }

                profileBtn.className = buttonClasses;
                profileBtn.textContent = initial;
                
                profileBtn.addEventListener('click', () => {
                    populateProfileModal();
                    openModal(profileModal);
                });
                
                profileWrapper.appendChild(profileBtn);
                authContainer.appendChild(profileWrapper);

                // 2. Update Main Content 
                if (isDashboardActive) {
                    showDashboard();
                    if (window.innerWidth < 768) {
                         sidebarToggleBtn.classList.remove('hidden');
                    }
                } else {
                    toggleDashboardView(false); // Show welcome screen
                    welcomeScreen.innerHTML = `
                        <div class="max-w-xl mx-auto mt-12">
                            <h2 class="text-4xl font-extrabold text-white">Welcome back, <span class="text-red-500">${currentUser.username}</span>!</h2>
                            <p class="mt-4 text-lg text-gray-400 mb-8">Your secure access token is active.</p>
                            
                            <button id="accessFilesBtn" class="px-8 py-4 bg-green-600 text-white text-xl font-bold rounded-full shadow-2xl hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i data-lucide="folder-open" class="w-6 h-6 mr-2 inline-block"></i>
                                Access Files
                            </button>

                            <p class="mt-8 text-md text-gray-500">Need details? Click the profile icon in the top right to view your Member ID.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    document.getElementById('accessFilesBtn').addEventListener('click', handleAccessFiles);
                }


            } else {
                // Logged Out
                toggleDashboardView(false); 
                
                const signInBtn = document.createElement('button');
                signInBtn.id = 'signInBtn';
                signInBtn.className = 'px-4 py-2 rounded-full text-white font-medium transition duration-150 shadow-md bg-red-600 hover:bg-red-700';
                signInBtn.textContent = 'Sign In or Log In';
                
                signInBtn.addEventListener('click', () => {
                    openModal(authModal);
                });
                
                authContainer.appendChild(signInBtn);
                
                welcomeScreen.innerHTML = `
                    <h2 class="text-3xl font-light text-gray-400">Welcome to the inner circle.</h2>
                    <p class="mt-4 text-gray-500">Sign in to access your member benefits and ID.</p>
                `;
            }
        }

        /**
         * Populates the Profile Modal with current user data.
         */
        function populateProfileModal() {
            if (!currentUser) return;
            
            const partyBadge = document.getElementById('partyBadge');
            const partyStatus = document.getElementById('aboutPartyStatus');

            document.getElementById('profileInitial').textContent = currentUser.name ? currentUser.name[0].toUpperCase() : 'U';
            document.getElementById('profileUsernameDisplay').textContent = currentUser.username;
            document.getElementById('profileEmailDisplay').textContent = currentUser.email;
            
            document.getElementById('memberIdDisplay').textContent = currentUser.memberId; 
            document.getElementById('adminRecordIdDisplay').textContent = currentUser.adminRecordId || 'N/A';

            document.getElementById('aboutUsername').textContent = currentUser.username;
            document.getElementById('aboutEmail').textContent = currentUser.email;
            document.getElementById('aboutMethod').textContent = currentUser.loginMethod;
            
            // Party Member Logic in Modal
            if (currentUser.isPartyMember) {
                partyBadge.classList.remove('hidden');
                partyStatus.textContent = "YES (Elite Access)";
                partyStatus.classList.add('text-yellow-400');
                partyStatus.classList.remove('text-gray-400');
            } else {
                partyBadge.classList.add('hidden');
                partyStatus.textContent = "No";
                partyStatus.classList.add('text-gray-400');
                partyStatus.classList.remove('text-yellow-400');
            }

            lucide.createIcons(); // Re-render icon in badge if necessary
        }
        
        /**
         * Handles the selection of a category in the sidebar.
         */
        async function handleCategorySelect(e) {
            const category = e.currentTarget.dataset.category;
            
            if (!currentUser || !currentUser.adminRecordId) {
                console.error("Cannot load category: User not fully logged in.");
                return;
            }

            // Highlight active link
            categoryLinks.forEach(link => link.classList.remove('bg-red-700', 'text-white'));
            e.currentTarget.classList.add('bg-red-700', 'text-white');
            
            // Update content title
            currentCategoryTitle.textContent = `${category} Dashboard`;

            // Clear previous content
            categoryContentWrapper.innerHTML = `<div class="text-gray-500">Loading ${category} data...</div>`;
            
            // --- Load data from Firestore ---
            const docPath = `artifacts/${appId}/public/data/members/${currentUser.adminRecordId}/widgets/${category}`;
            const docRef = doc(db, docPath);
            
            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    // 1. Data exists, load it into our global state
                    const categoryData = docSnap.data().widgets;
                    for (const widgetId in categoryData) {
                        const loadedWidget = categoryData[widgetId];
                        
                        // We load the persistent data
                        widgetStates[widgetId] = {
                            ...loadedWidget,
                            fileURL: null,      // Ensure temp URL is null on load
                            isEditing: false, // Ensure editing is false on load
                            isUploading: false
                        };
                    }
                    console.log(`Loaded ${Object.keys(categoryData).length} widgets from Firestore for: ${category}`);

                } else {
                    // 2. No data, create defaults and save them
                    console.log(`No widget data found for ${category}. Creating defaults...`);
                    const defaultWidgets = {};
                    for (let i = 1; i <= 4; i++) {
                        const widgetId = `${category}-${i}`;
                        const newWidget = { 
                            name: `${category} Metrics ${i}`, 
                            fileName: null, 
                            fileSize: null,
                            fileType: null,
                            downloadURL: null,
                            storagePath: null
                        };
                        widgetStates[widgetId] = { ...newWidget, fileURL: null, isEditing: false, isUploading: false }; // Add to global state
                        defaultWidgets[widgetId] = newWidget; // Add to object to be saved
                    }
                    // Save the new default widgets to Firestore
                    await setDoc(docRef, { widgets: defaultWidgets });
                    console.log(`Saved default widgets for: ${category}`);
                }

            } catch (error) {
                console.error(`Error loading/creating widgets for ${category}:`, error);
                categoryContentWrapper.innerHTML = `<div class="text-red-500">Error loading data. Please try again.</div>`;
                return;
            }
            // --- END NEW LOGIC ---


            // 1. Generate HTML for the grid container
            let widgetsHTML = '';
            widgetsHTML += `<div id="widgetGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 flex-grow">`; 

            // Find all loaded widgets for this category and render them
            let hasWidgets = false;
            for (const widgetId in widgetStates) {
                if (widgetId.startsWith(category + '-')) {
                    widgetsHTML += renderWidget(widgetId);
                    hasWidgets = true;
                }
            }
            
            if (!hasWidgets) {
                 console.warn("No widgets found in state after load. This shouldn't happen if defaults were created.");
            }
            
            widgetsHTML += `</div>`;
            
            // 2. Add the "Add New Widget" button container
            const buttonHTML = `
                <div id="addWidgetButtonContainer">
                    <button data-category="${category}" data-action="add-new" 
                        class="widget-action w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition transform active:scale-[.99]">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2 inline-block"></i>
                        Add New Widget
                    </button>
                </div>
            `;

            // 3. Inject into content panel
            categoryContentWrapper.innerHTML = widgetsHTML + buttonHTML;
            
            // Re-render lucide icons for new content
            lucide.createIcons();

            // On mobile, close sidebar after selection
            if (window.innerWidth < 768) {
                handleSidebarToggle(false);
            }
        }

        /**
         * Handles events delegated from the widget grid.
         */
        function handleWidgetInteraction(e) {
            // Updated selector to include .file-preview-block
            const target = e.target.closest('.widget-action, .file-preview-block, [data-action="file-change"]');
            if (!target) return;

            const action = target.dataset.action;
            const widgetId = target.dataset.id || target.id.replace('file-', '');
            const category = target.dataset.category;

            // These functions are now async
            if (action === 'toggle-edit') {
                toggleWidgetEdit(widgetId);
            } else if (action === 'file-change' && target.files && target.files.length > 0) {
                handleFileUpload(widgetId, target.files[0]);
            } else if (action === 'remove-file') {
                removeFile(widgetId);
            } else if (action === 'add-new') {
                addNewWidget(category);
            } else if (action === 'open-file') { 
                openFileInNewTab(widgetId);
            }
        }


        /**
         * Handles the final step of login (database save, state update, UI refresh).
         */
        async function completeLogin(userProps) {
            if (!db || !auth.currentUser) {
                 console.error("Database or Auth not ready. Cannot complete login.");
                 return;
            }

            const currentFirebaseUserId = auth.currentUser.uid;
            
            let memberId = localStorage.getItem('memberId');
            if (!memberId) {
                memberId = generateMemberId();
                localStorage.setItem('memberId', memberId);
                console.log("New persistent Member ID generated:", memberId);
            } else {
                console.log("Persistent Member ID restored from local storage:", memberId);
            }

            // --- PARTY MEMBER LOGIC ---
            const isPartyMember = userProps.username.toLowerCase() === 'partyadmin'; 
            console.log(`Party Member Check: ${isPartyMember ? 'YES' : 'NO'}`);
            // --------------------------

            const userRecord = {
                name: userProps.name,
                email: userProps.email,
                username: userProps.username,
                loginMethod: userProps.loginMethod,
                memberId: memberId, 
                isPartyMember: isPartyMember, // New field added
                firebaseUid: currentFirebaseUserId,
                createdAt: new Date().toISOString()
            };

            const collectionPath = `artifacts/${appId}/public/data/members`;
            const q = query(collection(db, collectionPath), where("firebaseUid", "==", currentFirebaseUserId));
            const existingDocs = await getDocs(q);
            
            let adminRecordId;

            if (!existingDocs.empty) {
                const docRef = existingDocs.docs[0].ref;
                adminRecordId = existingDocs.docs[0].id;
                
                await setDoc(docRef, {
                    name: userProps.name,
                    email: userProps.email,
                    username: userProps.username,
                    memberId: memberId,
                    loginMethod: userProps.loginMethod,
                    isPartyMember: isPartyMember, // Update existing record
                    firebaseUid: currentFirebaseUserId,
                    lastLogin: new Date().toISOString()
                }, { merge: true }); 

                console.log("Existing user record updated in Firestore:", adminRecordId);

            } else {
                const docRef = await addDoc(collection(db, collectionPath), userRecord);
                adminRecordId = docRef.id;
                console.log("New user record added to Firestore:", adminRecordId);
            }
            
            const finalUser = {
                ...userRecord,
                adminRecordId: adminRecordId, 
                memberId: memberId,
                isPartyMember: isPartyMember // Ensure local state is up to date
            };

            sessionStorage.setItem('allKnowingUser', JSON.stringify(finalUser));
            currentUser = finalUser;

            updateAppUI();
            
            return finalUser;
        }


        /**
         * Checks Firestore for an existing record tied to the current Firebase Auth user ID.
         */
        async function restoreUserFromDatabase() {
            if (!db || !auth.currentUser) return;

            const currentFirebaseUserId = auth.currentUser.uid;
            
            if (auth.currentUser.isAnonymous && !initialAuthToken) return;
            if (currentUser && currentUser.firebaseUid === currentFirebaseUserId) return; 

            console.log("Attempting to restore user session from Firestore...");
            
            const collectionPath = `artifacts/${appId}/public/data/members`;
            const q = query(collection(db, collectionPath), where("firebaseUid", "==", currentFirebaseUserId));
            
            try {
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    
                    const restoredUser = {
                        name: data.name,
                        email: data.email,
                        username: data.username,
                        memberId: data.memberId,
                        loginMethod: data.loginMethod,
                        isPartyMember: data.isPartyMember || false, // Default to false if missing
                        adminRecordId: doc.id,
                        firebaseUid: data.firebaseUid
                    };

                    localStorage.setItem('memberId', data.memberId); 
                    sessionStorage.setItem('allKnowingUser', JSON.stringify(restoredUser));
                    currentUser = restoredUser;
                    
                    console.log(`User session restored for ${data.username}. Party Member: ${restoredUser.isPartyMember}`);
                } else {
                    console.log("No existing record found in Firestore for this user ID. User must log in.");
                }
            } catch (error) {
                console.error("Error restoring user from Firestore:", error);
            }
            updateAppUI();
        }

        /**
         * Initializes Firebase and sets up the Auth state listener.
         */
        async function initializeAppAndAuth() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    storage = getStorage(app); // <-- Initialize Storage
                }

                const sessionData = sessionStorage.getItem('allKnowingUser');
                if (sessionData) {
                    currentUser = JSON.parse(sessionData);
                    isDashboardActive = sessionStorage.getItem('isDashboardActive') === 'true'; 
                }

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await restoreUserFromDatabase();
                        if (!currentUser) {
                             updateAppUI();
                        }
                    } else {
                        // The user will be anonymous if not logged in, but we still need to run updateAppUI to handle the sign in button.
                        // We check for currentUser in clearUser() to avoid an infinite loop if onAuthStateChanged fires immediately after a sign out.
                        if (!auth.currentUser) {
                            clearUser();
                        } else {
                            updateAppUI();
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                updateAppUI(); 
            }
        }


        // --- EVENT LISTENERS ---
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const userProps = { name, email, username, loginMethod: 'Manual Entry' };
            completeLogin(userProps); 
            closeModal(authModal);
        });

        document.getElementById('closeAuthModal').addEventListener('click', () => closeModal(authModal));
        document.getElementById('closeProfileModal').addEventListener('click', () => closeModal(profileModal));
        document.getElementById('closeInfoModal').addEventListener('click', () => closeModal(infoModal)); 
        backToDashboardBtn.addEventListener('click', showDashboard); // Button to go back to main dashboard

        authModal.addEventListener('click', (e) => { if (e.target === authModal) closeModal(authModal); });
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeModal(profileModal); });
        infoModal.addEventListener('click', (e) => { if (e.target === infoModal) closeModal(infoModal); }); 

        infoBtn.addEventListener('click', () => { 
            if (currentUser) {
                // Clear and open the Secret Code input modal
                secretIdInput.value = '';
                feedbackText.textContent = "Awaiting code...";
                feedbackText.className = 'text-gray-400 text-base italic';
                openModal(infoModal);
            } else {
                // If user is not logged in, prompt them to sign in
                openModal(authModal);
            }
        });


        changeUserBtn.addEventListener('click', () => {
            clearUser(); 
            closeModal(profileModal);
            updateAppUI();
            console.log('User successfully logged out.');
        });
        
        // Copy ID Buttons
        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.idType;
                const element = document.getElementById(targetId);
                
                if (element && element.textContent) {
                    const textToCopy = element.textContent.trim();
                    const tempInput = document.createElement('input');
                    tempInput.value = textToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);

                    // Show copy notification
                    const messageElement = document.getElementById('copyMessage');
                    let idName = 'ID';
                    if (targetId === 'memberIdDisplay') idName = 'Member ID';
                    if (targetId === 'adminRecordIdDisplay') idName = 'Admin Record ID';
                    
                    if (messageElement) {
                        messageElement.textContent = `${idName} copied!`;
                        messageElement.classList.remove('hidden', 'opacity-0');
                        messageElement.classList.add('opacity-100');
                        
                        setTimeout(() => {
                            messageElement.classList.remove('opacity-100');
                            messageElement.classList.add('opacity-0');
                            setTimeout(() => messageElement.classList.add('hidden'), 300);
                        }, 2000);
                    } else {
                        console.error("Copy notification element not found.");
                    }
                }
            });
        });
        
        // Sidebar and Category Listeners
        sidebarToggleBtn.addEventListener('click', () => handleSidebarToggle());
        sidebarOverlay.addEventListener('click', () => handleSidebarToggle(false)); 
        
        categoryLinks.forEach(link => {
            link.addEventListener('click', handleCategorySelect); // This is now async
        });

        // Event delegation for dynamically created widget elements
        categoryContentWrapper.addEventListener('click', handleWidgetInteraction);
        categoryContentWrapper.addEventListener('change', handleWidgetInteraction); // To catch file input changes
        
        // Handle window resize to adjust sidebar display logic
        window.addEventListener('resize', () => {
             if (window.innerWidth >= 768) {
                handleSidebarToggle(false); 
             }
        });

        // Save dashboard state before unload
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('isDashboardActive', isDashboardActive);
        });
        
        // --- SECRET ID INPUT LOGIC (FIXED) ---
        
        // 1. Handle Enter Key Press to process the code
        secretIdInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault(); // Stop the default form submission (if it were a form)
                processSecretId();
            }
        });

        // 2. Input Filtering: Only allow numbers
        secretIdInput.addEventListener('keypress', (event) => {
            const charCode = (event.which) ? event.which : event.keyCode;
            
            // Allow numbers (48-57)
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                event.preventDefault(); // Prevent non-numeric input
            }
        });

        
        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeAppAndAuth();
        });
    </script>
</body>
</html>

